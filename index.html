<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Snake â€” 10 Levels (Mobile)</title>
<meta name="description" content="Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ø¹Ø¨Ø§Ù† Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: 10 Ù…Ø³ØªÙˆÙŠØ§Øª Ù…Ø¹ Ù…ØªØ§Ù‡Ø§Øª ØªØ¯Ø±ÙŠØ¬ÙŠØ©ØŒ Ø³Ø±Ø¹Ø§Øª Ø³Ù‡Ù„/Ù…ØªÙˆØ³Ø·/ØµØ¹Ø¨ØŒ Ø§Ù„ØªÙØ§Ù Ø§Ù„Ø­ÙˆØ§ÙØŒ Ø£Ø²Ø±Ø§Ø± Ù„Ù…Ø³ØŒ Ø³ÙˆØ§ÙŠØ¨ØŒ Ø¥ÙŠÙ‚Ø§Ù/Ù…ØªØ§Ø¨Ø¹Ø© ÙˆÙ…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©.">
<style>
:root{--bg:#0b1b2b;--panel:#0f2438;--text:#eef6ff;--muted:#9fb1c7;--accent:#22c55e;--danger:#ef4444}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial;-webkit-tap-highlight-color:transparent;overflow:hidden}
.hidden{display:none!important}

/* Start + Levels */
.start{max-width:900px;margin:0 auto;padding:18px}
.hero{background:linear-gradient(130deg,#0b1b2b,#102a42 60%,#0b1b2b);border-radius:20px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.hero h1{margin:.2rem 0 .6rem;font-size:clamp(22px,4vw,34px)}
.hero p{color:var(--muted);line-height:1.7}
.levels{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-top:12px}
.levels button{background:#12273d;border:1px solid #24415e;border-radius:14px;color:#e7f1ff;padding:12px;cursor:pointer}
.levels button .tag{display:block;color:#9fb1c7;margin-top:6px}
.levels .lock{opacity:.55;position:relative}
.levels .lock::after{content:"ğŸ”’";position:absolute;right:10px;top:8px}

/* HUD */
.hud{position:fixed;top:env(safe-area-inset-top);left:0;right:0;display:flex;gap:8px;justify-content:center;align-items:center;padding:8px;background:linear-gradient(180deg,#0b1b2b,#0b1b2bcc);backdrop-filter:blur(6px);z-index:10}
.badge{background:#12273d;border:1px solid #24415e;border-radius:999px;padding:6px 10px}
.btn{background:#102538;border:1px solid #1c2b3f;color:#fff;padding:8px 12px;border-radius:12px;cursor:pointer}
.btn-primary{background:linear-gradient(180deg,#2dd4bf,#10b981);border:0;color:#06241a}
.btn-small{font-size:14px}
.board{position:fixed;left:0;right:0;top:48px;bottom:0;display:flex;align-items:center;justify-content:center}
canvas{display:block;border:2px solid #0c2236;border-radius:16px;background:#0f331a;touch-action:none}

/* Touch controls */
.touchpad{position:fixed;left:0;right:0;bottom:env(safe-area-inset-bottom);display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 16px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.35));z-index:12}
.touchpad button{width:88px;height:56px;border-radius:14px;border:1px solid #1c2b3f;background:#102538;color:#fff;font-size:22px;font-weight:800}
.touchpad .lr{display:flex;gap:10px}
@media (hover:hover) and (pointer:fine){.touchpad{display:none}}

/* Overlays */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:20}
.card{background:#0f2438;border:1px solid #173250;border-radius:16px;padding:16px;min-width:260px;text-align:center}
.card h2{margin:.3rem 0 .6rem}
.row{display:flex;gap:10px;justify-content:center}
.hint{color:#b7c6d9;font-size:.92rem}
</style>
</head>
<body>

<!-- START / LEVELS -->
<section id="screenStart" class="start">
  <div class="hero">
    <h1>Snake â€” Ù†Ø³Ø®Ø© Ù…ÙˆØ¨Ø§ÙŠÙ„ (10 Ù…Ø³ØªÙˆÙŠØ§Øª)</h1>
    <p>Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ù…Ù‚Ø³Ù‘Ù…Ø©: <b>Ø³Ù‡Ù„</b> 1â€“3ØŒ <b>Ù…ØªÙˆØ³Ø·</b> 4â€“7ØŒ <b>ØµØ¹Ø¨</b> 8â€“10. Ø§Ù„Ù‡Ø¯Ù: Ø¬Ù…Ø¹ Ø¹Ø¯Ø¯ ØªÙÙ‘Ø§Ø­Ø§Øª Ù„ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰. Ø§Ù„Ø«Ø¹Ø¨Ø§Ù† ÙŠÙ„ÙÙ‘ Ù…Ù† Ø§Ù„Ø­ÙˆØ§Ù (ÙŠØ¯Ø®Ù„ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø£Ø®Ø±Ù‰).</p>
    <div id="levels" class="levels"></div>
    <p class="hint">Ù†ØµÙŠØ­Ø©: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ù‡Ù… Ø£Ùˆ Ø§Ù„Ø³ÙˆØ§ÙŠØ¨ Ø£Ùˆ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„Ù…Ø³. â¸ Ù„Ø¥ÙŠÙ‚Ø§Ù/Ù…ØªØ§Ø¨Ø¹Ø©ØŒ â›¶ Ù„Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©.</p>
  </div>
</section>

<!-- GAME HUD -->
<header id="hud" class="hud hidden">
  <span id="labelLevel" class="badge">Lv 1 â€” Ø³Ù‡Ù„</span>
  <span id="labelGoal" class="badge">Ù‡Ø¯Ù: 6</span>
  <span id="labelScore" class="badge">0</span>
  <span id="labelBest"  class="badge">Ø£ÙØ¶Ù„ 0</span>
  <button id="pauseBtn" class="btn btn-small" title="Ø¥ÙŠÙ‚Ø§Ù/Ù…ØªØ§Ø¨Ø¹Ø©">â¸</button>
  <button id="fsBtn" class="btn btn-small" title="Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©">â›¶</button>
  <button id="exitBtn" class="btn btn-small" title="Ø®Ø±ÙˆØ¬">âœ•</button>
</header>

<!-- GAME BOARD -->
<main id="board" class="board hidden">
  <canvas id="canvas" aria-label="Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©" role="img"></canvas>
  <div class="touchpad" aria-label="ØªØ­ÙƒÙ… Ù„Ù…Ø³">
    <button id="btnUp">â–²</button>
    <div class="lr">
      <button id="btnLeft">â—€</button>
      <button id="btnRight">â–¶</button>
    </div>
    <button id="btnDown">â–¼</button>
  </div>
</main>

<!-- RESULT -->
<section id="overlay" class="overlay hidden" aria-modal="true" role="dialog">
  <div class="card">
    <h2 id="ovTitle">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
    <p>Ù†ØªÙŠØ¬ØªÙƒ: <b id="finalScore">0</b></p>
    <div class="row">
      <button id="retryBtn" class="btn btn-primary">Ø¥Ø¹Ø§Ø¯Ø©</button>
      <button id="levelsBtn" class="btn">Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</button>
    </div>
  </div>
</section>

<script>
/* ===================== BASIC DOM ===================== */
const el = id => document.getElementById(id);
const screenStart = el('screenStart');
const levelsWrap  = el('levels');
const hud         = el('hud');
const board       = el('board');
const overlay     = el('overlay');
const labelLevel  = el('labelLevel');
const labelGoal   = el('labelGoal');
const labelScore  = el('labelScore');
const labelBest   = el('labelBest');
const pauseBtn    = el('pauseBtn');
const fsBtn       = el('fsBtn');
const exitBtn     = el('exitBtn');
const retryBtn    = el('retryBtn');
const levelsBtn   = el('levelsBtn');
const ovTitle     = el('ovTitle');
const finalScore  = el('finalScore');
const btnUp=el('btnUp'), btnDown=el('btnDown'), btnLeft=el('btnLeft'), btnRight=el('btnRight');

const cvs = el('canvas'), ctx = cvs.getContext('2d');

/* ===================== STORE ===================== */
const STORE_KEY='snake10:v1';
const store = JSON.parse(localStorage.getItem(STORE_KEY) || '{"best":0,"unlocked":1}');
function saveStore(){ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }

/* ===================== LEVELS CONFIG ===================== */
/* stepMs: Ø§Ù„Ø³Ø±Ø¹Ø© (Ø£ØµØºØ± = Ø£Ø³Ø±Ø¹) | goal: Ø¹Ø¯Ø¯ Ø§Ù„ØªÙØ§Ø­Ø§Øª Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ */
const LEVELS = [
  {name:'Lv1',  tag:'Ø³Ù‡Ù„',    stepMs:150, goal:6,  maze:0},
  {name:'Lv2',  tag:'Ø³Ù‡Ù„',    stepMs:140, goal:7,  maze:1},
  {name:'Lv3',  tag:'Ø³Ù‡Ù„',    stepMs:135, goal:8,  maze:2},
  {name:'Lv4',  tag:'Ù…ØªÙˆØ³Ø·',  stepMs:125, goal:9,  maze:3},
  {name:'Lv5',  tag:'Ù…ØªÙˆØ³Ø·',  stepMs:120, goal:10, maze:4},
  {name:'Lv6',  tag:'Ù…ØªÙˆØ³Ø·',  stepMs:115, goal:11, maze:5},
  {name:'Lv7',  tag:'Ù…ØªÙˆØ³Ø·',  stepMs:110, goal:12, maze:6},
  {name:'Lv8',  tag:'ØµØ¹Ø¨',    stepMs:100, goal:13, maze:7},
  {name:'Lv9',  tag:'ØµØ¹Ø¨',    stepMs: 90, goal:14, maze:8},
  {name:'Lv10', tag:'ØµØ¹Ø¨',    stepMs: 80, goal:16, maze:9}
];

/* ===================== GRID & RESIZE ===================== */
const COLS=24, ROWS=32; // Ù…Ù†Ø·Ù‚ Ø«Ø§Ø¨ØªØŒ Ø§Ù„Ø±Ø³Ù… ÙŠØªØ­Ø¬Ù‘Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
let SCALE=20;
function resize(){
  const rect = board.getBoundingClientRect();
  const availW = Math.floor(window.innerWidth);
  const availH = Math.floor(window.innerHeight - rect.top);
  SCALE = Math.max(12, Math.floor(Math.min(availW/COLS, availH/ROWS)));
  cvs.width = COLS * SCALE; cvs.height = ROWS * SCALE;
}
window.addEventListener('resize', resize);

/* ===================== GAME STATE ===================== */
let levelIdx=0, stepMs=140, goal=6;
let snake=[], dir={x:1,y:0}, lastDir={x:1,y:0}, apple={x:0,y:0};
let score=0, best=store.best||0, alive=true, paused=false;
let raf=0, last=0, acc=0;
let walls = new Set(); // "x,y" Ù„ÙƒÙ„ Ø¬Ø¯Ø§Ø±

/* ===================== MAZES (Ù…ØªØ§Ù‡Ø§Øª ØªØ¯Ø±ÙŠØ¬ÙŠØ©) ===================== */
function key(x,y){ return x+','+y; }
function addRect(x,y,w,h){
  for(let j=0;j<h;j++)for(let i=0;i<w;i++){
    // Ù„Ø§ Ù†Ø¶Ø¹ Ø¬Ø¯Ø§Ø±Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙˆØ§Ù Ù…Ø¨Ø§Ø´Ø±Ø© Ø­ØªÙ‰ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø§Ù„ØªÙØ§Ù Ù…ÙÙŠØ¯Ù‹Ø§
    if(x+i<=0 || x+i>=COLS-1 || y+j<=0 || y+j>=ROWS-1) continue;
    walls.add(key(x+i,y+j));
  }
}
function buildMaze(type){
  walls.clear();
  switch(type){
    case 0: /* no walls */ break;
    case 1: // Ù…Ø³ØªØ·ÙŠÙ„ ØµØºÙŠØ± ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ
      addRect(Math.floor(COLS/2)-2, Math.floor(ROWS/2)-2, 4, 4);
      break;
    case 2: // Ø¹Ù…ÙˆØ¯Ø§Ù† Ø±Ø£Ø³ÙŠØ§Ù†
      addRect(Math.floor(COLS/3), 4, 2, ROWS-8);
      addRect(Math.floor(COLS*2/3), 4, 2, ROWS-8);
      break;
    case 3: // Ù‚ÙØ¶Ø¨Ø§Ù† Ø£ÙÙ‚ÙŠØ© Ù…ØªÙ‚Ø·Ø¹Ø©
      for(let y=6;y<ROWS-6;y+=6){ addRect(4, y, COLS-8, 2); }
      break;
    case 4: // ØµÙ„ÙŠØ¨ + Ù…Ø±Ø¨Ø¹Ø§Øª Ø²ÙˆØ§ÙŠØ§ ØµØºÙŠØ±Ø©
      addRect(Math.floor(COLS/2)-1, 4, 2, ROWS-8);
      addRect(4, Math.floor(ROWS/2)-1, COLS-8, 2);
      addRect(5,5,3,3); addRect(COLS-8,5,3,3); addRect(5,ROWS-8,3,3); addRect(COLS-8,ROWS-8,3,3);
      break;
    case 5: // Ø£Ø¹Ù…Ø¯Ø© (Pillars) Ø¹Ù„Ù‰ Ù†Ù…Ø· Ø´Ø¨ÙƒØ©
      for(let y=6;y<ROWS-6;y+=6) for(let x=5;x<COLS-5;x+=6) addRect(x,y,2,2);
      break;
    case 6: // Ù…Ù…Ø±Ø§Øª Ø²Ø¬Ø²Ø§Ø¬
      for(let y=4;y<ROWS-4;y+=4){
        const len=COLS-10, start=(y%8===0)?5:COLS-len-5;
        addRect(start,y, len, 1);
      }
      break;
    case 7: // Ø­Ù„Ø²ÙˆÙ†ÙŠ Ø¨Ø³ÙŠØ·
      let x1=4,y1=4,x2=COLS-5,y2=ROWS-5;
      while(x1<x2 && y1<y2){
        addRect(x1,y1, x2-x1, 1);
        addRect(x1,y2, x2-x1, 1);
        addRect(x1,y1, 1, y2-y1);
        addRect(x2,y1, 1, y2-y1);
        x1+=3;y1+=3;x2-=3;y2-=3;
      }
      break;
    case 8: // Ù…Ù…Ø±Ø§Øª Ø±Ø£Ø³ÙŠØ© Ù…Ø¹ ÙØªØ­Ø§Øª
      for(let x=5;x<COLS-5;x+=4){
        addRect(x, 4, 1, ROWS-8);
        // ÙØªØ­Ø§Øª
        for(let k=6;k<ROWS-6;k+=8) walls.delete(key(x,k));
      }
      break;
    case 9: // Ù…ØªØ§Ù‡Ø© Ù…Ø®ØªÙ„Ø·Ø© (Ø´Ø¨ÙƒØ© + ØµÙ„ÙŠØ¨)
      addRect(Math.floor(COLS/2)-1, 3, 2, ROWS-6);
      addRect(3, Math.floor(ROWS/2)-1, COLS-6, 2);
      for(let y=6;y<ROWS-6;y+=5) for(let x=6;x<COLS-6;x+=7) addRect(x,y,1,1);
      break;
  }
}

/* ===================== HELPERS ===================== */
function randInt(n){ return Math.floor(Math.random()*n); }
function placeApple(){
  while(true){
    const x=randInt(COLS), y=randInt(ROWS);
    if(walls.has(key(x,y))) continue;
    if(snake.some(s=>s.x===x && s.y===y)) continue;
    apple = {x,y}; return;
  }
}
function setDir(nx,ny){
  if(nx===-lastDir.x && ny===-lastDir.y) return; // Ù…Ù†Ø¹ Ø§Ù„Ø±Ø¬ÙˆØ¹ 180Â°
  if(nx && ny) ny=0; // Ù„Ø§ Ø§ØªØ¬Ø§Ù‡ Ù‚Ø·Ø±ÙŠ
  dir={x:nx,y:ny};
}

/* ===================== START/RESET LEVEL ===================== */
function resetLevel(i){
  levelIdx=i;
  const L = LEVELS[i];
  stepMs=L.stepMs; goal=L.goal;
  buildMaze(L.maze);
  // Ø«Ø¹Ø¨Ø§Ù† Ù‚ØµÙŠØ± Ø¨Ø¨Ø¯Ø§ÙŠØ© Ø¢Ù…Ù†Ø©
  snake=[{x:3,y:Math.floor(ROWS/2)},{x:2,y:Math.floor(ROWS/2)},{x:1,y:Math.floor(ROWS/2)}];
  dir={x:1,y:0}; lastDir={x:1,y:0};
  score=0; alive=true; paused=false; acc=0; last=0;
  placeApple();
  labelLevel.textContent = `Lv ${i+1} â€” ${L.tag}`;
  labelGoal.textContent  = `Ù‡Ø¯Ù: ${goal}`;
  labelScore.textContent = `0`;
  labelBest.textContent  = `Ø£ÙØ¶Ù„ ${best}`;
}

/* ===================== LOOP (Fixed timestep) ===================== */
const MIN_STEP=70; // Ø³Ù‚Ù Ø§Ù„Ø³Ø±Ø¹Ø©
function step(){
  if(!alive) return;
  // Ø±Ø£Ø³ Ø¬Ø¯ÙŠØ¯ + Ø§Ù„ØªÙØ§Ù Ø§Ù„Ø­ÙˆØ§Ù
  let nx = (snake[0].x + dir.x + COLS) % COLS;
  let ny = (snake[0].y + dir.y + ROWS) % ROWS;
  // Ø§ØµØ·Ø¯Ø§Ù… Ø¨Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
  if(walls.has(key(nx,ny))) return die();
  // Ø§ØµØ·Ø¯Ø§Ù… Ø¨Ø§Ù„Ø°Ø§Øª
  if(snake.some(s=>s.x===nx && s.y===ny)) return die();

  const head={x:nx,y:ny};
  const ate = (nx===apple.x && ny===apple.y);
  snake.unshift(head);
  if(ate){
    score++; labelScore.textContent=String(score);
    placeApple();
    stepMs = Math.max(MIN_STEP, stepMs - 2); // ØªØ³Ø±ÙŠØ¹ Ø¨Ø³ÙŠØ· Ù…Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù…
    if(score>=goal) return win();
  }else{
    snake.pop();
  }
  lastDir=dir;
}
function loop(t){
  const dt = t - (last||t); last=t;
  if(!paused && alive){
    acc += dt;
    while(acc >= stepMs){ step(); acc -= stepMs; }
  }
  render();
  raf = requestAnimationFrame(loop);
}

/* ===================== RENDER ===================== */
function roundRect(x,y,w,h,r){
  ctx.beginPath(); ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); ctx.fill();
}
function render(){
  // Ø®Ù„ÙÙŠØ© Ù…ÙƒØ³Ù‘Ø±Ø© Ø®ÙÙŠÙØ©
  ctx.fillStyle='#0d3a1d'; ctx.fillRect(0,0,cvs.width,cvs.height);
  ctx.fillStyle='rgba(255,255,255,0.03)';
  for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++) if(((x+y)&1)===0)
    ctx.fillRect(x*SCALE,y*SCALE,SCALE,SCALE);

  // Ø¬Ø¯Ø±Ø§Ù†
  ctx.fillStyle='#173b5b';
  walls.forEach(k=>{
    const [x,y]=k.split(',').map(Number);
    roundRect(x*SCALE+2,y*SCALE+2,SCALE-4,SCALE-4,6);
  });

  // ØªÙØ§Ø­Ø©
  ctx.fillStyle='#ffd54a';
  ctx.beginPath();
  ctx.arc(apple.x*SCALE+SCALE/2, apple.y*SCALE+SCALE/2, SCALE*0.35, 0, Math.PI*2);
  ctx.fill();

  // Ø«Ø¹Ø¨Ø§Ù† (Ø±Ø£Ø³ Ù…Ù…ÙŠØ² + Ø¬Ø³Ù…)
  for(let i=snake.length-1;i>=0;i--){
    const s=snake[i];
    if(i===0){
      // Ø±Ø£Ø³
      const gx=s.x*SCALE, gy=s.y*SCALE;
      const grad=ctx.createLinearGradient(gx,gy,gx,gy+SCALE);
      grad.addColorStop(0,'#39ff14'); grad.addColorStop(1,'#0fbf4a');
      ctx.fillStyle=grad; roundRect(gx+2,gy+2,SCALE-4,SCALE-4,8);
      // Ø¹ÙŠÙ†ÙŠÙ† Ø¨Ø³ÙŠØ·ØªÙŠÙ†
      ctx.fillStyle='#0b1b2b';
      const ex=gx+SCALE/2 + (dir.x*3), ey=gy+SCALE/2 + (dir.y*3);
      ctx.beginPath(); ctx.arc(ex-4,ey-4,2,0,6.283); ctx.arc(ex+4,ey-4,2,0,6.283); ctx.fill();
    }else{
      ctx.fillStyle='#14e38b';
      roundRect(s.x*SCALE+3, s.y*SCALE+3, SCALE-6, SCALE-6, 6);
    }
  }
}

/* ===================== END STATES ===================== */
function die(){
  alive=false;
  finalScore.textContent=score; ovTitle.textContent='Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©';
  overlay.classList.remove('hidden');
  best=Math.max(best, score); store.best=best; saveStore();
}
function win(){
  alive=false;
  finalScore.textContent=score; ovTitle.textContent='Ù…Ø³ØªÙˆÙ‰ Ù…ÙƒØªÙ…Ù„ ğŸ‰';
  overlay.classList.remove('hidden');
  // ÙØªØ­ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ
  store.unlocked = Math.max(store.unlocked||1, levelIdx+2);
  store.best = Math.max(store.best||0, score);
  saveStore();
}

/* ===================== INPUT ===================== */
window.addEventListener('keydown',e=>{
  if(e.key==='ArrowUp') setDir(0,-1);
  else if(e.key==='ArrowDown') setDir(0,1);
  else if(e.key==='ArrowLeft') setDir(-1,0);
  else if(e.key==='ArrowRight') setDir(1,0);
  else if(e.key===' '){ e.preventDefault(); togglePause(); }
});
function hold(btn,on){ if(!btn) return; btn.addEventListener('pointerdown',e=>{e.preventDefault(); on();}); }
hold(btnUp,   ()=>setDir(0,-1));
hold(btnDown, ()=>setDir(0, 1));
hold(btnLeft, ()=>setDir(-1,0));
hold(btnRight,()=>setDir(1, 0));
// Ø³ÙˆØ§ÙŠØ¨
let sx=0, sy=0, swiping=false;
cvs.addEventListener('pointerdown', e=>{ swiping=true; sx=e.clientX; sy=e.clientY; cvs.setPointerCapture?.(e.pointerId); });
cvs.addEventListener('pointerup', e=>{
  if(!swiping) return; swiping=false;
  const dx=e.clientX-sx, dy=e.clientY-sy;
  if(Math.abs(dx)>Math.abs(dy)){ if(Math.abs(dx)>18) setDir(dx>0?1:-1,0); }
  else{ if(Math.abs(dy)>18) setDir(0, dy>0?1:-1); }
},{passive:true});

/* ===================== UI FLOW ===================== */
function togglePause(){ paused=!paused; pauseBtn.textContent = paused?'â–¶':'â¸'; }
pauseBtn.addEventListener('click', togglePause);
fsBtn.addEventListener('click', ()=>{
  if(!document.fullscreenElement){
    (document.documentElement.requestFullscreen||document.body.requestFullscreen).call(document.documentElement);
  } else { document.exitFullscreen?.(); }
});
exitBtn.addEventListener('click', backToLevels);
retryBtn.addEventListener('click', ()=>{ overlay.classList.add('hidden'); resetLevel(levelIdx); });
levelsBtn.addEventListener('click', backToLevels);

function backToLevels(){
  cancelAnimationFrame(raf);
  overlay.classList.add('hidden');
  board.classList.add('hidden'); hud.classList.add('hidden');
  screenStart.classList.remove('hidden');
  buildLevels();
}
function startLevel(i){
  screenStart.classList.add('hidden');
  hud.classList.remove('hidden');
  board.classList.remove('hidden');
  resize();
  resetLevel(i);
  cancelAnimationFrame(raf); last=0; acc=0;
  raf=requestAnimationFrame(loop);
}
function buildLevels(){
  levelsWrap.innerHTML='';
  LEVELS.forEach((L,i)=>{
    const b=document.createElement('button');
    const locked = (i+1)>(store.unlocked||1);
    b.className = 'level '+(locked?'lock':'');
    b.innerHTML = `<strong>${i+1}</strong> <span class="tag">${L.tag} â€¢ Ù‡Ø¯Ù ${L.goal}</span>`;
    b.disabled = locked;
    b.addEventListener('click', ()=>startLevel(i));
    levelsWrap.appendChild(b);
  });
}
buildLevels();
</script>
</body>
</html>
